'use strict';

Object.defineProperty(exports, '__esModule', {
  value: true
});

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _parserCountParser = require('../parser/countParser');

var _parserCountParser2 = _interopRequireDefault(_parserCountParser);

var _parserFilterParser = require('../parser/filterParser');

var _parserFilterParser2 = _interopRequireDefault(_parserFilterParser);

var _parserOrderbyParser = require('../parser/orderbyParser');

var _parserOrderbyParser2 = _interopRequireDefault(_parserOrderbyParser);

var _parserSkipParser = require('../parser/skipParser');

var _parserSkipParser2 = _interopRequireDefault(_parserSkipParser);

var _parserTopParser = require('../parser/topParser');

var _parserTopParser2 = _interopRequireDefault(_parserTopParser);

var _parserSelectParser = require('../parser/selectParser');

var _parserSelectParser2 = _interopRequireDefault(_parserSelectParser);

exports['default'] = function (req, mongooseModel, options) {
  return new Promise(function (resolve, reject) {
    var resData = {};

    var query = mongooseModel.find();

    var errHandle = function errHandle(err) {
      err.status = 500;
      return reject(err);
    };
    var err = undefined;

    /*jshint -W084 */
    if (err = (0, _parserCountParser2['default'])(resData, mongooseModel, req.query.$count, req.query.$filter)) {
      return errHandle(err);
    }

    /*jshint -W084 */
    if (err = (0, _parserFilterParser2['default'])(query, req.query.$filter)) {
      return errHandle(err);
    }

    /*jshint -W084 */
    if (err = (0, _parserOrderbyParser2['default'])(query, req.query.$orderby || options.orderby)) {
      return errHandle(err);
    }

    /*jshint -W084 */
    if (err = (0, _parserSkipParser2['default'])(query, req.query.$skip, options.maxSkip)) {
      return errHandle(err);
    }

    /*jshint -W084 */
    if (err = (0, _parserTopParser2['default'])(query, req.query.$top, options.maxTop)) {
      return errHandle(err);
    }

    /*jshint -W084 */
    if (err = (0, _parserSelectParser2['default'])(query, req.query.$select)) {
      return errHandle(err);
    }

    // TODO
    // $expand=Customers/Orders
    // $search

    query.exec(function (err, data) {
      resData.value = data;
      return resolve({ entity: resData });
    });
  });
};

module.exports = exports['default'];